@using Microsoft.AspNetCore.Identity
@using TicketMasala.Domain.Entities
@using TicketMasala.Domain.Common
@using TicketMasala.Web
@using Microsoft.AspNetCore.Mvc.Localization
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager


@{
    ViewData["Title"] = "Ticket Masala";
    ViewData["Description"] = Localizer["Your all-in-one project and ticket management solution"];
    ViewData["HideSidebar"] = !SignInManager.IsSignedIn(User);
}

    <!-- Dashboard Header -->
    <div class="dashboard-header text-center mb-4">
        <h1 class="dashboard-title d-flex align-items-center justify-content-center">
            <img src="~/images/logo.png" alt="Ticket Masala" height="48" class="me-3" />
            @Localizer["Welcome to Ticket Masala"]
        </h1>
        <p class="dashboard-subtitle">
            @Localizer["Your all-in-one project and ticket management solution"]
        </p>
    </div>
    <!-- Quick Stats for Authenticated Users -->
    <div class="stats-grid">
        <a asp-controller="Projects" asp-action="Index" class="stat-card primary text-decoration-none transform-hover">
            <i class="fas fa-folder-open stat-card-icon"></i>
            <div class="stat-card-title text-white">@Localizer["Your Projects"]</div>
            <div class="stat-card-value text-white">@(ViewBag.ProjectCount ?? 0)</div>
            <div class="stat-card-change text-white-50">
                <i class="fas fa-arrow-up me-1"></i> @Localizer["{0} new this week", ViewBag.NewProjectsThisWeek ?? 0]
            </div>
        </a>
        
        <a asp-controller="Ticket" asp-action="Index" class="stat-card secondary text-decoration-none transform-hover">
            <i class="fas fa-ticket-alt stat-card-icon"></i>
            <div class="stat-card-title text-white">@Localizer["Active Tickets"]</div>
            <div class="stat-card-value text-white">@(ViewBag.ActiveTicketCount ?? 0)</div>
            <div class="stat-card-change text-white-50">
                <i class="fas fa-check me-1"></i> @Localizer["{0} completed today", ViewBag.CompletedToday ?? 0]
            </div>
        </a>
        
        @if (!User.IsInRole("Customer"))
        {
            <a asp-controller="Dashboard" asp-action="TeamDashboard" class="stat-card warning text-decoration-none transform-hover">
                <i class="fas fa-clock stat-card-icon"></i>
                <div class="stat-card-title text-white">@Localizer["Pending Tasks"]</div>
                <div class="stat-card-value text-white">@(ViewBag.PendingTaskCount ?? 0)</div>
                <div class="stat-card-change text-white-50">
                    <i class="fas fa-exclamation-circle me-1"></i> @Localizer["{0} due soon", ViewBag.DueSoon ?? 0]
                </div>
            </a>
            
            <a asp-controller="Dispatch" asp-action="DispatchBacklog" class="stat-card success text-decoration-none transform-hover">
                <i class="fas fa-chart-line stat-card-icon"></i>
                <div class="stat-card-title text-white">@Localizer["Completion Rate"]</div>
                <div class="stat-card-value text-white">@(ViewBag.CompletionRate ?? 0)%</div>
                <div class="stat-card-change">
                    <i class="fas fa-trophy me-1"></i> @Localizer["Great progress!"]
                </div>
            </a>
        }
    </div>

    <!-- Quick Actions -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <a asp-controller="Projects" asp-action="NewProject" class="card h-100 text-center text-decoration-none transform-hover">
                <div class="card-body p-4">
                    <div class="mb-3">
                        <div class="icon-circle bg-primary-subtle text-primary mx-auto">
                            <i class="fas fa-plus fa-2x"></i>
                        </div>
                    </div>
                    <h3 class="card-title h5 text-dark">@Localizer["Create Project"]</h3>
                    <p class="text-secondary mb-0">@Localizer["Start a new project"]</p>
                </div>
            </a>
        </div>
        
        <div class="col-md-4">
            <a asp-controller="Ticket" asp-action="Create" class="card h-100 text-center text-decoration-none transform-hover">
                <div class="card-body p-4">
                    <div class="mb-3">
                        <div class="icon-circle bg-success-subtle text-success mx-auto">
                            <i class="fas fa-ticket-alt fa-2x"></i>
                        </div>
                    </div>
                    <h3 class="card-title h5 text-dark">@Localizer["Create Ticket"]</h3>
                    <p class="text-secondary mb-0">@Localizer["Raise a new issue"]</p>
                </div>
            </a>
        </div>
        
        @if (User.IsInRole("Employee") || User.IsInRole("Admin"))
        {
            <div class="col-md-4">
                <a asp-controller="Customer" asp-action="Index" class="card h-100 text-center text-decoration-none transform-hover">
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <div class="icon-circle bg-info-subtle text-info mx-auto">
                                <i class="fas fa-users fa-2x"></i>
                            </div>
                        </div>
                        <h3 class="card-title h5 text-dark">@Localizer["Manage Customers"]</h3>
                        <p class="text-secondary mb-0">@Localizer["View client directory"]</p>
                    </div>
                </a>
            </div>
        }
    </div>

    <!-- GERDA AI Insights -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary-subtle text-primary-emphasis d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">
                <i class="fas fa-robot me-2"></i> @Localizer["GERDA AI Insights"]
            </h3>
            <span class="badge bg-primary text-white">@Localizer["Live Analysis"]</span>
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    @if ((ViewBag.HighRiskCount ?? 0) > 0 || (ViewBag.SentimentWarningCount ?? 0) > 0)
                    {
                        <div class="d-flex gap-3 flex-wrap">
                            @if ((ViewBag.HighRiskCount ?? 0) > 0)
                            {
                                <div class="alert alert-danger mb-0 d-flex align-items-center py-2 px-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <div>
                                        <strong>@(ViewBag.HighRiskCount)</strong> @Localizer["Critical Risks"]
                                    </div>
                                </div>
                            }
                            @if ((ViewBag.SentimentWarningCount ?? 0) > 0)
                            {
                                <div class="alert alert-warning mb-0 d-flex align-items-center py-2 px-3">
                                    <i class="fas fa-meh me-2"></i>
                                    <div>
                                        <strong>@(ViewBag.SentimentWarningCount)</strong> @Localizer["Sentiment Warnings"]
                                    </div>
                                </div>
                            }
                        </div>
                        <p class="text-secondary mt-2 mb-0 small">
                            @Localizer["GERDA has flagged these items for immediate attention based on pattern analysis."]
                        </p>
                    }
                    else
                    {
                        <div class="d-flex align-items-center text-success">
                            <i class="fas fa-check-circle fa-2x me-3"></i>
                            <div>
                                <h5 class="mb-0">@Localizer["System Healthy"]</h5>
                                <p class="mb-0 small text-secondary">@Localizer["No critical anomalies detected in active tickets."]</p>
                            </div>
                        </div>
                    }
                </div>
                <div class="col-md-4 text-end">
                     <a asp-controller="TicketSearch" asp-action="Index" class="btn btn-outline-primary btn-sm">
                        @Localizer["View All Analysis"] <i class="fas fa-arrow-right ms-1"></i>
                     </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-history me-2"></i>
                @Localizer["Recent Activity"]
            </h3>
        </div>
        <div class="card-body">
            <div class="ticket-list">
                @if (ViewBag.RecentActivity != null)
                {
                    var activities = (List<TicketMasala.Web.ViewModels.Tickets.TicketViewModel>)ViewBag.RecentActivity;
                    
                    if (activities != null && activities.Any())
                    {
                        foreach (var ticket in activities)
                        {
                            <a href="@Url.Action("Details", "Ticket", new { id = ticket.Guid })" class="text-decoration-none text-dark">
                                <div class="ticket-item transform-hover" style="cursor: pointer;">
                                    <div class="ticket-header">
                                        <span class="ticket-id">#@ticket.Guid.ToString().Substring(0, 8)</span>
                                        <span class="badge @(ticket.TicketStatus.ToString() == "Completed" ? "badge-success" : ticket.TicketStatus.ToString() == "Pending" ? "badge-pending" : "badge-in-progress")">
                                            @ticket.TicketStatus
                                        </span>
                                    </div>
                                    <div class="ticket-description">@ticket.Description</div>
                                    <div class="ticket-footer text-secondary">
                                        <i class="fas fa-user me-1"></i> @ticket.ResponsibleName
                                        <i class="fas fa-clock ms-3 me-1"></i> @ticket.CreationDate.ToLocalTime().ToString("g")
                                    </div>
                                </div>
                            </a>
                        }
                    }
                    else
                    {
                        <p class="text-muted text-center my-4">@Localizer["No recent activity found."]</p>
                    }
                }
            </div>
        </div>
    </div>
    
    <script>
        // Add fade-in animation to cards
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('fade-in');
                }, index * 100);
            });
        });
    </script>

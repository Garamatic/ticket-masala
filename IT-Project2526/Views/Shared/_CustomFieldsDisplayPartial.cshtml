@using IT_Project2526.Models.Configuration
@using System.Text.Json
@model IEnumerable<CustomFieldDefinition>

@{
    var customFieldValues = ViewBag.CustomFieldValues as Dictionary<string, object> ?? new Dictionary<string, object>();
}

@if (Model != null && Model.Any() && customFieldValues.Any())
{
    <div class="custom-fields-display">
        <h5 class="mb-3">
            <i class="fas fa-sliders-h me-2 text-secondary"></i>
            Additional Information
        </h5>
        
        <dl class="row">
            @foreach (var field in Model)
            {
                if (customFieldValues.TryGetValue(field.Name, out var rawValue) && rawValue != null)
                {
                    var displayValue = FormatValue(rawValue, field.Type);
                    
                    if (!string.IsNullOrWhiteSpace(displayValue))
                    {
                        <dt class="col-sm-4">@field.Label</dt>
                        <dd class="col-sm-8">
                            @switch (field.Type.ToLowerInvariant())
                            {
                                case "currency":
                                    <span class="text-success fw-semibold">$@displayValue</span>
                                    break;
                                case "boolean":
                                    if (displayValue == "Yes")
                                    {
                                        <span class="badge bg-success">Yes</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">No</span>
                                    }
                                    break;
                                default:
                                    @displayValue
                                    break;
                            }
                        </dd>
                    }
                }
            }
        </dl>
    </div>
}

@functions {
    string FormatValue(object value, string fieldType)
    {
        if (value == null) return string.Empty;
        
        // Handle JsonElement
        if (value is JsonElement jsonElement)
        {
            return jsonElement.ValueKind switch
            {
                JsonValueKind.String => jsonElement.GetString() ?? string.Empty,
                JsonValueKind.Number => jsonElement.GetRawText(),
                JsonValueKind.True => "Yes",
                JsonValueKind.False => "No",
                JsonValueKind.Array => string.Join(", ", jsonElement.EnumerateArray().Select(e => e.GetString())),
                _ => jsonElement.GetRawText()
            };
        }
        
        // Handle standard types
        return fieldType.ToLowerInvariant() switch
        {
            "boolean" => value.ToString()?.Equals("true", StringComparison.OrdinalIgnoreCase) == true ? "Yes" : "No",
            "date" when DateTime.TryParse(value.ToString(), out var dt) => dt.ToString("yyyy-MM-dd"),
            _ => value.ToString() ?? string.Empty
        };
    }
}
